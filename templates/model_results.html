{% extends "base.html" %}

{% block title %}FinModAI - Model Results{% endblock %}

{% block content %}
<!-- Model Navigation Bar -->
<div class="bg-navy text-white mb-6 rounded-lg shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center">
            <h1 class="text-xl font-bold">{{ ticker }}</h1>
            <span class="mx-3 text-gray-300">|</span>
            <span class="text-sm font-medium">{{ model_type.upper() }} Model - {{ climate.title() }} Case</span>
        </div>
        <div class="flex items-center space-x-3">
            <a href="/generate-model" class="text-sm bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-colors">
                New Model
            </a>
            <a href="/models" class="text-sm bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-colors">
                All Models
            </a>
        </div>
    </div>
</div>

<div class="grid grid-cols-12 gap-6">
    <!-- Left Panel - Model Info and Results -->
    <div class="col-span-12 lg:col-span-8">
        <div class="space-y-6">
            <!-- Company-Specific Assumptions -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Company-Specific Assumptions</h2>
                
                <div class="max-h-70vh overflow-y-auto border border-gray-200 rounded-lg p-4">
                    {{ assumptions_html | safe }}
                </div>
            </div>
            
            <!-- Model Overview -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Model Overview</h2>
                
                <div class="max-h-70vh overflow-y-auto border border-gray-200 rounded-lg p-4">
                    <div class="prose prose-sm max-w-none">
                        <h3 class="text-base font-medium">DCF Summary â€” {{ ticker }}</h3>
                        <p>EV: $2.5B | Implied Price: $25.00 | Current: $20.00 | Upside: 25.0%<br>
                        WACC: 10.5% | Terminal: Perpetuity g=2.5%</p>
                        
                        <h4 class="text-sm font-medium mt-4">Key Drivers</h4>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>Revenue growth: 8.0% over forecast period</li>
                            <li>EBITDA margin: 25.0%</li>
                            <li>Terminal rationale: Perpetuity growth model at 2.5%</li>
                            <li>Sensitivities that move value: WACC sensitivity, terminal growth sensitivity</li>
                        </ul>
                        
                        <h4 class="text-sm font-medium mt-4">Sanity Checks</h4>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>TV share of EV: 75.0%</li>
                            <li>Implied equity vs market cap: $2.0B vs $1.8B</li>
                            <li>g < WACC: True</li>
                        </ul>
                        
                        <p class="mt-4 font-medium">RECOMMENDATION: BUY | Confidence: H | Why: Significant upside potential with strong fundamentals</p>
                    </div>
                </div>
            </div>
            
            <!-- Valuation Results -->
            <div class="bg-white rounded-xl shadow-sm p-6 print-break-inside-avoid">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Valuation Results</h2>
                {{ valuation_html | safe }}
            </div>
            
            <!-- Download Section -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Download Results</h2>
                <div class="bg-success-bg text-success p-4 rounded-lg flex items-center justify-between mb-4">
                    <span class="font-medium">Model generated successfully!</span>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button onclick="window.print()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                        </svg>
                        Print Results
                    </button>
                    
                    <a href="/download-excel" class="bg-success text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-opacity-90 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download Excel Model
                    </a>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="bg-white rounded-xl shadow-sm p-6 no-print">
                <h3 class="font-medium text-gray-900 mb-4">Next Steps</h3>
                <div class="flex flex-wrap gap-3">
                    <a href="/generate-model" class="bg-navy text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-opacity-90 transition-colors">
                        Generate Another Model
                    </a>
                    <a href="/models" class="bg-white text-navy border border-navy px-3 py-2 rounded-md text-sm font-medium hover:bg-navy hover:text-white transition-colors">
                        View All Models
                    </a>
                    <a href="/" class="bg-gray-50 text-gray-600 px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-100 transition-colors">
                        Home
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel - Chat Assistant -->
    <div class="col-span-12 lg:col-span-4 lg:sticky lg:top-6 h-fit">
        <div class="bg-white rounded-xl shadow-sm flex flex-col">
            <header class="px-4 py-3 border-b flex items-center">
                <div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-4 h-4 text-navy" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium text-gray-900">Analyst Assistant</span>
            </header>

            <div id="chat-messages" class="max-h-[60vh] overflow-y-auto p-4" aria-live="polite">
                <div class="text-xs text-gray-400 text-center py-2">
                    Ask me anything about this {{ model_type.upper() }} model!
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50">
                <div class="flex space-x-2">
                    <input type="text" id="chat-input" placeholder="Ask about assumptions, valuation, or risks..." 
                           class="flex-1 px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-navy focus:border-navy"
                           aria-label="Chat input">
                    <button id="chat-send" class="bg-navy text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-opacity-90 transition-colors"
                            aria-label="Send message">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
                <div id="chat-loading" class="hidden mt-2">
                    <div class="flex items-center justify-center py-2">
                        <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-navy"></div>
                        <span class="ml-2 text-xs text-gray-600">AI is thinking...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Chat FAB -->
<button id="mobile-chat-fab" aria-label="Open chat" class="fixed bottom-4 right-4 w-12 h-12 rounded-full bg-navy text-white shadow-lg flex items-center justify-center lg:hidden z-50">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
    </svg>
</button>

<!-- Mobile Chat Bottom Sheet -->
<div id="mobile-chat-sheet" class="fixed inset-x-0 bottom-0 h-[65vh] bg-white rounded-t-xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out lg:hidden z-50">
    <div class="flex flex-col h-full">
        <!-- Header -->
        <div class="px-4 py-3 border-b flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center mr-3">
                    <svg class="w-4 h-4 text-navy" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium text-gray-900">Analyst Assistant</span>
            </div>
            <button id="close-mobile-chat" class="p-2 hover:bg-gray-100 rounded-full">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Messages -->
        <div id="mobile-chat-messages" class="flex-1 p-4 overflow-y-auto" aria-live="polite">
            <div class="text-xs text-gray-400 text-center py-2">
                Ask me anything about this {{ model_type.upper() }} model!
            </div>
        </div>
        
        <!-- Input -->
        <div class="p-4 border-t bg-gray-50" style="padding-bottom: env(safe-area-inset-bottom, 12px);">
            <div class="flex space-x-2">
                <input type="text" id="mobile-chat-input" placeholder="Ask about assumptions, valuation, or risks..." 
                       class="flex-1 px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-navy focus:border-navy"
                       aria-label="Chat input">
                <button id="mobile-chat-send" class="bg-navy text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-opacity-90 transition-colors"
                        aria-label="Send message">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
            <div id="mobile-chat-loading" class="hidden mt-2">
                <div class="flex items-center justify-center py-2">
                    <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-navy"></div>
                    <span class="ml-2 text-xs text-gray-600">AI is thinking...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function setupChat(modelId) {
    // Desktop chat elements
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const chatMessages = document.getElementById('chat-messages');
    const chatLoading = document.getElementById('chat-loading');
    
    // Mobile chat elements
    const mobileChatFab = document.getElementById('mobile-chat-fab');
    const mobileChatSheet = document.getElementById('mobile-chat-sheet');
    const mobileChatInput = document.getElementById('mobile-chat-input');
    const mobileChatSend = document.getElementById('mobile-chat-send');
    const mobileChatMessages = document.getElementById('mobile-chat-messages');
    const mobileChatLoading = document.getElementById('mobile-chat-loading');
    const closeMobileChat = document.getElementById('close-mobile-chat');
    
    function addMessage(content, isUser = false, isMobile = false) {
        const targetMessages = isMobile ? mobileChatMessages : chatMessages;
        const messageEl = document.createElement('div');
        messageEl.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-2`;
        
        const bubbleEl = document.createElement('div');
        bubbleEl.className = `max-w-xs lg:max-w-md px-3 py-2 rounded-lg text-xs ${isUser ? 'bg-navy text-white' : 'bg-gray-50 text-gray-700 border border-gray-100'}`;
        bubbleEl.textContent = content;
        
        messageEl.appendChild(bubbleEl);
        targetMessages.appendChild(messageEl);
        targetMessages.scrollTop = targetMessages.scrollHeight;
    }
    
    async function sendMessage(isMobile = false) {
        const input = isMobile ? mobileChatInput : chatInput;
        const loading = isMobile ? mobileChatLoading : chatLoading;
        const messages = isMobile ? mobileChatMessages : chatMessages;
        
        const question = input.value.trim();
        if (!question) return;
        
        // Add user message
        addMessage(question, true, isMobile);
        input.value = '';
        
        // Show loading
        loading.classList.remove('hidden');
        
        try {
            // Simulate API call
            setTimeout(() => {
                loading.classList.add('hidden');
                addMessage("I'm here to help with your questions about this {{ model_type.upper() }} model. What specific aspect would you like to know more about?", false, isMobile);
            }, 1000);
        } catch (error) {
            console.error('Chat error:', error);
            loading.classList.add('hidden');
            addMessage('Sorry, I encountered an error. Please try again.', false, isMobile);
        }
    }
    
    // Desktop chat event listeners
    chatSend.addEventListener('click', () => sendMessage(false));
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage(false);
        }
    });
    
    // Mobile chat event listeners
    mobileChatSend.addEventListener('click', () => sendMessage(true));
    mobileChatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage(true);
        }
    });
    
    // Mobile FAB and bottom sheet
    mobileChatFab.addEventListener('click', function() {
        mobileChatSheet.classList.remove('translate-y-full');
        mobileChatInput.focus();
    });
    
    closeMobileChat.addEventListener('click', function() {
        mobileChatSheet.classList.add('translate-y-full');
    });
    
    // Auto-scroll chat into view on desktop load
    if (window.innerWidth >= 1024) {
        setTimeout(() => {
            const chatPanel = document.querySelector('.lg\\:sticky');
            if (chatPanel) {
                chatPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 500);
    }
}

// Initialize chat when the page loads
document.addEventListener('DOMContentLoaded', function() {
    setupChat('{{ model_id }}');
});
</script>
{% endblock %}